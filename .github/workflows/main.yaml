name: mobile

concurrency:
  group: $-$
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  semantic-pull-request:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/semantic_pull_request.yml@v1
  spell-check:
    uses: VeryGoodOpenSource/very_good_workflows/.github/workflows/spell_check.yml@v1
    with:
      includes: |
        **/*.md
      modified_files_only: false
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.7.7
          cache: true

      - name: ğŸ“¦ Install Dependencies
        run: |
          flutter pub global activate very_good_cli
          very_good --analytics false
          very_good packages get --recursive

      - name: ğŸš§ Set Secrets and ENV
        # created on https://github.com/kelvin-273o15/paramount-client/settings/secrets/actions
        env:
          APP_ENV: ${{ secrets.APP_ENV }}
          APP_LOCAL: ${{ env.APP_ENV }}
        run: |
          cat <<EOF > .env
          APP_ENV=$APP_ENV
          APP_LOCAL=$APP_LOCAL
          EOF
          cat .env

      - name: ğŸš€ Run Build Runner
        run: flutter pub run build_runner build

      - name: âœ¨ Check Formatting
        run: dart format --set-exit-if-changed lib test

      - name: ğŸ•µï¸ Analyze
        run: flutter analyze lib test

      - name: ğŸ§ª Run Tests
        run: very_good test -j 4 --recursive --optimization --coverage --test-randomize-ordering-seed random

      - name: ğŸ“Š Check Code Coverage
        uses: VeryGoodOpenSource/very_good_coverage@v2
        with:
          path: ./coverage/lcov.info
          min_coverage: 100
